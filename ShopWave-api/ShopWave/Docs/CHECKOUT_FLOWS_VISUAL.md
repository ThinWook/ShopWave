# ?? CHECKOUT FLOWS - VISUAL DIAGRAMS

## 1?? COD Flow (Simple)

```
???????????
? Client  ?
???????????
     ?
     ? POST /api/v1/checkout (paymentMethod: "COD")
     ?
???????????????????????????????????????????????????
?           CheckoutController                     ?
?                                                  ?
?  1. Get Cart                                     ?
?     ?? CartItems                                ?
?     ?? AppliedDiscounts                         ?
?                                                  ?
?  2. Check Stock                                 ?
?     ?? foreach CartItem                         ?
?     ?? if Stock < Quantity ? Error              ?
?                                                  ?
?  3. Calculate                                   ?
?     ?? SubTotal                                 ?
?     ?? Shipping Fee                             ?
?     ?? Voucher Discount                         ?
?     ?? Total = SubTotal + Shipping - Discount   ?
?                                                  ?
?  4. Create Order                                ?
?     ?? Status = "PROCESSING"                    ?
?     ?? PaymentStatus = "UNPAID"                 ?
?     ?? PaymentMethod = "COD"                    ?
?                                                  ?
?  5. Create OrderItems (Snapshot)                ?
?     ?? ProductName                              ?
?     ?? UnitPrice                                ?
?     ?? Quantity                                 ?
?                                                  ?
?  6. Create Transaction                          ?
?     ?? Gateway = "COD"                          ?
?     ?? Status = "PENDING"                       ?
?     ?? Amount = Order.TotalAmount               ?
?                                                  ?
?  7. Reduce Stock                                ?
?     ?? ProductVariant.Stock -= Quantity         ?
?                                                  ?
?  8. Delete Cart                                 ?
?     ?? Delete CartItems                         ?
?     ?? Delete AppliedDiscounts                  ?
?     ?? Delete Cart                              ?
?                                                  ?
?  9. Send Email (TODO)                           ?
?                                                  ?
?  10. Commit & Return 201 Created                ?
???????????????????????????????????????????????????
                   ?
                   ?
              ???????????
              ? Client  ?
              ?         ?
              ? Success ?
              ?  Page   ?
              ???????????

?? Time: ~500ms
? Stock: Reduced immediately
? Cart: Deleted immediately
? Order: Ready for warehouse
```

---

## 2?? VNPay/MoMo Flow (Complex)

### Step 1: Create Payment URL

```
???????????
? Client  ?
???????????
     ?
     ? POST /api/v1/checkout (paymentMethod: "VNPAY")
     ?
???????????????????????????????????????????????????
?           CheckoutController                     ?
?                                                  ?
?  1-3. Same as COD (Get Cart, Check, Calculate)  ?
?                                                  ?
?  4. Create Order                                ?
?     ?? Status = "PENDING_PAYMENT"  ??           ?
?     ?? PaymentStatus = "UNPAID"                 ?
?     ?? PaymentMethod = "VNPAY"                  ?
?                                                  ?
?  5. Create OrderItems (Snapshot)                ?
?                                                  ?
?  6. Create Transaction                          ?
?     ?? Gateway = "VNPAY"                        ?
?     ?? Status = "PENDING"                       ?
?     ?? Amount = Order.TotalAmount               ?
?                                                  ?
?  7. ?? DO NOT Reduce Stock                      ?
?  8. ?? DO NOT Delete Cart                       ?
?                                                  ?
?  9. Create Payment URL                          ?
?     ?? PaymentGatewayService                    ?
?                                                  ?
?  10. Return 200 OK with Payment URL             ?
???????????????????????????????????????????????????
                   ?
                   ?
              ???????????
              ? Client  ?
              ? Redirect?
              ???????????
                   ?
                   ? User opens Payment URL
                   ?
         ????????????????????
         ?  VNPay Website   ?
         ?                  ?
         ?  [Pay Button]    ?
         ????????????????????
              ?
              ? User completes payment
              ?
              ??????????????????????????????????
                    ?            ?             ?
                    ?            ?             ?
              Return URL    IPN Webhook   Email (VNPay)
             (to Client)  (to Backend)
```

### Step 2: Webhook Callback (Critical!)

```
????????????
?  VNPay   ?
????????????
     ?
     ? POST /api/v1/payments/webhook/vnpay
     ? (Server-to-Server call)
     ?
???????????????????????????????????????????????????
?        PaymentWebhookController                  ?
?                                                  ?
?  1. Parse Query Params                          ?
?     ?? vnp_TxnRef (TransactionId)               ?
?     ?? vnp_ResponseCode (00 = success)          ?
?     ?? vnp_TransactionNo (gateway ID)           ?
?                                                  ?
?  2. ? Validate Signature (HMAC-SHA512)         ?
?     ?? if invalid ? Return 400                  ?
?                                                  ?
?  3. Find Transaction & Order                    ?
?     ?? if not found ? Return OK (01)            ?
?                                                  ?
?  4. Check Idempotency                           ?
?     ?? if Status != PENDING ? Return OK         ?
?                                                  ?
?  5. Update Transaction                          ?
?     ?? GatewayTransactionId = vnp_TransactionNo ?
?     ?? GatewayResponse = JSON                   ?
?     ?? CompletedAt = NOW                        ?
?                                                  ?
?  6. if vnp_ResponseCode == "00" (SUCCESS)       ?
?     ?? Transaction.Status = "SUCCESS"           ?
?     ?? Order.Status = "PROCESSING"              ?
?     ?? Order.PaymentStatus = "PAID"             ?
?     ?                                            ?
?     ?? ? Reduce Stock NOW                      ?
?     ?  ?? foreach OrderItem                     ?
?     ?     ?? ProductVariant.Stock -= Quantity   ?
?     ?                                            ?
?     ?? ? Delete Cart NOW                       ?
?        ?? Delete CartItems                      ?
?        ?? Delete AppliedDiscounts               ?
?        ?? Delete Cart                           ?
?                                                  ?
?  7. else (FAILED)                               ?
?     ?? Transaction.Status = "FAILED"            ?
?     ?? Order.Status = "CANCELLED"               ?
?     ?? Stock/Cart unchanged                     ?
?                                                  ?
?  8. SaveChanges & Return 200 OK                 ?
???????????????????????????????????????????????????
                   ?
                   ?
              ????????????
              ?  VNPay   ?
              ?          ?
              ? Received ?
              ????????????

?? Time: ~10-30 seconds (from user payment to webhook)
? Stock: Reduced on webhook success
? Cart: Deleted on webhook success
?? Race Condition: Handled by idempotency check
```

### Step 3: Return URL (User Experience)

```
????????????
?  VNPay   ?
????????????
     ?
     ? Redirect to Return URL
     ? GET /api/v1/payments/return?gateway=vnpay&vnp_ResponseCode=00&...
     ?
???????????????????????????????????????????????????
?        PaymentWebhookController                  ?
?                                                  ?
?  1. Parse Query Params                          ?
?     ?? vnp_ResponseCode                         ?
?                                                  ?
?  2. Determine Success/Failure                   ?
?     ?? isSuccess = (vnp_ResponseCode == "00")   ?
?                                                  ?
?  3. Redirect to Frontend                        ?
?     ?? if success ? /checkout/success           ?
?     ?? else ? /checkout/failed                  ?
???????????????????????????????????????????????????
                   ?
                   ?
              ???????????
              ? Client  ?
              ?         ?
              ? Success ?
              ?  Page   ?
              ???????????

?? Important: This is for USER EXPERIENCE only
             Real payment processing happens in Webhook
```

---

## 3?? Race Condition Handling

```
Timeline:

T+0s   User clicks "Pay" on VNPay
       ?
T+5s   User completes payment on VNPay
       ?
       ?????????????????????????????????????
       ?                 ?                 ?
T+6s   ?            Webhook arrives   Return URL redirects
       ?            (Backend)         (Browser)
       ?                 ?                 ?
       ?            [Process]         [Wait...]
       ?                 ?                 ?
T+7s   ?            Stock reduced     Page shows "Processing..."
       ?            Cart deleted           ?
       ?            Status = SUCCESS       ?
       ?                 ?                 ?
T+8s   ?                 ?            Frontend polls order status
       ?                 ?                 ?
T+9s   ?                 ?            Shows "Success!"
       ?                 ?                 ?
       ?                 ?                 ?

? Webhook processes FIRST (usually)
? Return URL just shows UI
? If Return URL arrives first, frontend polls for order status
? Idempotency check prevents duplicate processing
```

---

## 4?? Database State Timeline

### COD:
```
T+0s: Order Created
????????????????????????????
? Orders                   ?
????????????????????????????
? Status: PROCESSING       ? ?
? PaymentStatus: UNPAID    ? ?
? PaymentMethod: COD       ?
????????????????????????????

????????????????????????????
? Transactions             ?
????????????????????????????
? Gateway: COD             ? ?
? Status: PENDING          ? ?
????????????????????????????

????????????????????????????
? ProductVariants          ?
????????????????????????????
? Stock: 10 ? 8            ? ? Reduced
????????????????????????????

????????????????????????????
? Carts                    ?
????????????????????????????
? (deleted)                ? ?
????????????????????????????
```

### VNPay/MoMo (Before Webhook):
```
T+0s: Order Created
????????????????????????????
? Orders                   ?
????????????????????????????
? Status: PENDING_PAYMENT  ? ??
? PaymentStatus: UNPAID    ?
? PaymentMethod: VNPAY     ?
????????????????????????????

????????????????????????????
? Transactions             ?
????????????????????????????
? Gateway: VNPAY           ?
? Status: PENDING          ? ??
????????????????????????????

????????????????????????????
? ProductVariants          ?
????????????????????????????
? Stock: 10                ? ?? NOT reduced
????????????????????????????

????????????????????????????
? Carts                    ?
????????????????????????????
? Items: [...]             ? ?? NOT deleted
????????????????????????????
```

### VNPay/MoMo (After Webhook Success):
```
T+10s: Webhook Processed
????????????????????????????
? Orders                   ?
????????????????????????????
? Status: PROCESSING       ? ? Changed
? PaymentStatus: PAID      ? ? Changed
? PaymentMethod: VNPAY     ?
????????????????????????????

????????????????????????????
? Transactions             ?
????????????????????????????
? Gateway: VNPAY           ?
? Status: SUCCESS          ? ? Changed
? GatewayTransactionId: XX ? ? Filled
????????????????????????????

????????????????????????????
? ProductVariants          ?
????????????????????????????
? Stock: 10 ? 8            ? ? NOW reduced
????????????????????????????

????????????????????????????
? Carts                    ?
????????????????????????????
? (deleted)                ? ? NOW deleted
????????????????????????????
```

---

## 5?? Error Scenarios

### Scenario 1: Out of Stock
```
Client ? POST /api/v1/checkout
    ?
CheckoutController checks stock
    ?
if (Stock < Quantity)
    ?
Return 400 Bad Request
    ?
Client shows error message
    ?
NO order created
NO stock changed
NO cart deleted
```

### Scenario 2: Payment Failed (VNPay)
```
User ? VNPay ? Payment Failed
    ?
VNPay ? Webhook (vnp_ResponseCode != "00")
    ?
PaymentWebhookController
    ?? Transaction.Status = "FAILED"
    ?? Order.Status = "CANCELLED"
    ?? NO stock reduction
       NO cart deletion
    ?
Return URL ? Client shows "Payment Failed"
```

### Scenario 3: Webhook Timeout
```
User pays ? VNPay
    ?
Webhook delayed (network issue)
    ?
Client shows "Processing..."
    ?
Frontend polls: GET /api/v1/orders/{id}
    ?
if (Status == "PENDING_PAYMENT")
    ?? Keep polling (max 60s)
    ?
Webhook finally arrives
    ?
Next poll shows "PROCESSING"
    ?
Client shows success
```

---

## ?? Summary Table

| Feature | COD | VNPay/MoMo |
|---------|-----|------------|
| **API Calls** | 1 | 3 (Create + Webhook + Return) |
| **Time** | ~500ms | ~10-30s |
| **Stock Reduction** | Immediate | On webhook success |
| **Cart Deletion** | Immediate | On webhook success |
| **Order Status** | PROCESSING | PENDING_PAYMENT ? PROCESSING |
| **Transaction Log** | Yes (COD) | Yes (VNPAY/MOMO) |
| **Webhook** | No | Yes (critical) |
| **Complexity** | Low | Medium |
| **Risk** | Low (no online payment) | Medium (race conditions) |

---

**Created:** 2025-01-15  
**Purpose:** Visual understanding of checkout flows  
**Audience:** Developers, QA, Product Managers
